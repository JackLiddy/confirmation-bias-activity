<!-- 
    Confirmation Bias Activity

    This activity is emulate Peter Wason's confirmation bias experiment.
    The user is presented with three numbers that follow a certain rule, which they have to eventually determine.
    The user must then enter three numbers that they think follow the same rule.
    The user's entries are displayed in a table, along with the reason they think the numbers follow the rule.
    The point is for users to realize that they are biased towards confirming their own hypothesis, and that they should try to disprove it instead.

    The activity is broken into two parts: the admin panel and the user panel.
    The admin panel is used to set the rule that the user must guess.
    The user panel is used to enter their guesses and reasons for why they think the numbers follow the rule.
    The user panel also displays the entries in a table, and allows the user to guess the rule.
    The user can also view the correct rule from the admin panel.

    
 -->
<!DOCTYPE html>
<html>
    <head>
        <title>Confirmation Bias</title>
        <style>

            body {
                font-family: Arial, sans-serif;
                background-color: #121212;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
            }

            .app-container {
                /* width: 500px; */
                display: flex;
                align-items: flex-start;
                /* min-width: 300px; */
                gap: 20px;
            }

            .input-pane {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;


                background-color: #fff;
                padding: 20px;
                border-radius: 10px;
                /* box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); */
                margin-bottom: 20px;
                box-shadow: 4px 4px 3px 0px #6d39a8;
            }

            #dataForm {
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            form {
                /* background-color: #fff;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                margin-bottom: 20px; */
            }

            table {
                background-color: #fff;
                border-collapse: collapse;
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                min-width: 300px;
            }
            th,
            td {
                padding: 10px;
                border: 1px solid #ddd;
            }
            th {
                background-color: #f0f0f0;
            }
            /* tr:hover {
                background-color: #f5f5f5;
            } */
            input[type="number"],
            input[type="text"] {
                padding: 10px;
                margin: 5px 0;
                border: 1px solid #ddd;
                border-radius: 5px;
                /* width: calc(100% - 22px); */
                width: 80%;

            }
            input[type="submit"] {
                background-color: #4a2d6b;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                /* margin-top: 10px; */
            }
            input[type="submit"]:hover {
                background-color: #45a049;
            }

            /* input[type="number"],
            input[type="text"] {
                padding: 10px;
                margin: 5px 0;
                border: 1px solid #ddd;
                border-radius: 5px;
                width: calc(100% - 22px);
            } */
            button {
                background-color: #4caf50;
                color: white;
                padding: 10px 20px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin-top: 10px;
            }
            button:hover {
                background-color: #45a049;
            }

            .slider {
                /* -webkit-appearance: none; */
                width: 100%;
                /* height: 25px; */
                /* background: #d3d3d3; */
                /* outline: none; */
                /* opacity: 0.7; */
                -webkit-transition: 0.2s;
                /* transition: opacity 0.2s; */
            }

            .slider {
                -webkit-appearance: none;
                width: 100%;
                height: 15px;
                background: #d3d3d3;
                outline: none;
                opacity: 0.9;
                -webkit-transition: 0.3s;
                transition: opacity 0.3s;
            }

            .slider::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 35px;
                height: 35px;
                border: 0;
                background: url("assets/anon-raven-icon.png");
                cursor: pointer;
            }

            .slider::-moz-range-thumb {
                width: 35px;
                height: 35px;
                border: 0;
                background: url("assets/anon-raven-icon.png.png");
                cursor: pointer;
            }
            .slider:hover {
                opacity: 1;
            }




            .num-entry-row {
                display: flex;
                flex-direction: row;
            }


            .confidence-and-submit-container {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                width: 100%;
                gap: 10px;
                background: #6d39a8;
                padding: 8px;
            }


            /* final guess button disbaled until 3 entries */
            #finalGuessButton {
                /* display: none; */
                /* testing */
                display: block;
            }

            #seriesEntryForm {
                display: flex;
                align-items: center;
                justify-content: center;
                background: #6d39a8;
                padding: 8px;
                color: #ffffff;
                border-radius: 5px;
            }

            #seriesEntryForm input[type="number"] {
                text-align: center;
                margin: 0 10px;
                width: 50px; /* adjust as needed */
                -moz-appearance: textfield; /* disable field arrows on Firefox */
                background: #6d39a8;
                color: #ffffff;
                border: none;
                border-bottom: #ffffff 2px solid;
                border-radius: 0px;
            }
            #seriesEntryForm input[type="number"]:hover {
                background: #8344cb;;
            }
            /* Disable field arrows on Chrome / Safaro */
            #seriesEntryForm input[type="number"]::-webkit-outer-spin-button,
            input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            #admin-panel {
                /* margin-right: 20px; */
                display: none;
            }


            /* Results page styles */

            .results-page-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
                gap: 30px;

                display: none;
            }

            .rule-description-container {
                display: flex;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                width: 60%;
                height: 15%;
                background-color: #ffffff;
            }
            .rule-description-text {
                /* display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%; */
                /* background-color: #ffffff; */
                text-align: center;
            }
            .rule-description-text h2 {
                /* font-size: 30px; */
                font-family: sans-serif;
                text-align: center;
                margin: 5px;
            }
            .rule-description-image {

                position: relative;
                width: 37px;


                /* display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                width: 40%;
                height: 100%; */
                /* background-color: #ffffff; */

            }
            .rule-description-image img {
                /* width: 100%; */
                /* height: 100%; */
                /* background-color: #ffffff; */
                width: 112px;
                position: absolute;
                bottom: -60px;
                left: -72px;
            }

            .guess-summary-area {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                width: 90%;
                height: 70%;
                background-color: #ffffff;
            }
            .summary-header-text {
                display: flex;
                flex-direction: column;
                text-align: center;
            }
            .summary-header-text h2 {
                /* font-size: 30px; */
                font-family: sans-serif;
                text-align: center;
                margin: 5px;
            }
            .summary-body {
                display: flex;
                flex-direction: row;
                justify-content: space-evenly;
                /* margin-top: 40px; */
                height: 80%;
            }
            .summary-body-left {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                width: 60%;
                height: 100%;
                /* background-color: #ffffff; */
            }
            .summary-body-right {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                width: 35%;
                height: 100%;
                /* background-color: #ffffff; */
            }

            /* .results-page-container { */

            /* styled table with even spacing, white text, white lines, purple backgroun */
            #resultsTable {
                border-collapse: collapse;
                width: 100%;
                color: white;
                font-family: sans-serif;
                font-size: 15px;
                text-align: center;
                background-color: #6d38a8;
                /* font-size: clamp(1rem, 2.5vw, 2rem); */
            }
            .results-table-header {
                background-color: #6d38a8;
                color: white;
                padding: 10px;
                border: 1px solid #ddd;
            }
            .results-table-row:nth-child(even) {
                background-color: #6d38a8;
                color: white;
                padding: 10px;
            }
            .results-table-row:nth-child(odd) {
                background-color: #6d38a8;
                color: white;
                padding: 10px;
            }
            .results-table-cell {
                /* background-color: #6d38a8; */
                color: white;
                padding: 15px;
                border: 1px solid #ddd;
            }

            button {
                background-color: #6d38a8;
                color: white;
                padding: 20px;
                border: 1px solid #ddd;
                font-size: medium;
            }

            #next-guess-btn {
                /* margin-top: 20px; */
            }
            #compare-results-btn {
                /* margin-top: 20px; */
                display: none;
            }


            .highlighted-row {
                background-color: #291143 !important;  /* change this color as needed */
            }

        



        </style>
    </head>
    <body>
        <div class="app-container">
            <div class="input-pane" id="admin-panel">
                <h1>Dev setup panel</h1>
                <p>
                    Manualy select the rule in the UI for testing / demo
                    purposes
                </p>
                <label for="correctRule">Rule:</label>
                <select id="correctRule" name="correctRule">
                    <!-- <option value="Increase by 1">Increase by 1</option> -->
                </select>
            </div>
            <div class="input-pane">
                <h1>Activity 1.1 Confirmation Bias</h1>

                <form id="dataForm">
                    <p>
                        Enter a series of three numbers to see if that series
                        meets my rule
                    </p>
                    <div id="seriesEntryForm">
                        <input
                            type="number"
                            id="number1"
                            maxlength="4"
                            pattern="\d*"
                            inputmode="numeric"
                            max="9999"
                            required
                        />
                        <span>,</span>
                        <input
                            type="number"
                            id="number2"
                            maxlength="4"
                            pattern="\d*"
                            inputmode="numeric"
                            max="9999"
                            required
                        />
                        <span>,</span>
                        <input
                            type="number"
                            id="number3"
                            maxlength="4"
                            pattern="\d*"
                            inputmode="numeric"
                            max="9999"
                            required
                        />
                    </div>

                    <!-- <label for="rule">Rule:</label> -->

                    <p>Type the rule you are testing with your above guess</p>

                    <input
                        type="text"
                        id="rule"
                        name="rule"
                        required
                    /><br /><br />

                    <p>Drag Rigorous Raven to show your confidence in your guess</p>

                    <label for="myRange" id="confidence-label"
                        >Confidence: 50%</label
                    >
                    
                    <div class="confidence-and-submit-container">

                        <input
                            type="range"
                            min="0"
                            max="100"
                            value="50"
                            class="slider"
                            id="myRange"
                            oninput="updateSliderLabel()"
                        />

                        <input type="submit" value="Submit Your Guess" name="submitGuessBtn" id="submitGuessBtn"/> 
                    
                    </div>


                    <input type="submit" value="Submit Final Guess" name="finalGuessBtn" id="finalGuessBtn"/> 

                    <!-- <button
                        id="finalGuessButton"
                        type="submit"
                        onclick="submitFinalGuess()"

                    >
                        Submit Final Guess
                    </button> -->

                    <!-- <button id="showRuleBtn" type="button">Show Rule</button> -->
                </form>
            </div>

            <!-- Div to display the API response -->
            <!-- <div id="apiResponse"></div> -->

            <!-- Table to Display Entries -->
            <table id="dataTable">
                <tr id="tableBody">
                    <th>Entry #</th>
                    <th>Instance</th>
                    <th>Rule</th>
                    <th>Matches Rule</th>
                    <th>Confidence</th>
                </tr>
            </table>
        </div>

        <!-- Results section -->
        <div class="results-page-container">
            <!-- Rule description header -->
            <div class="rule-description-container">
                <!-- image here -->
                <div class="rule-description-image">
                    <img class="rule-description-raven" src="assets/raven-white-bg-05.svg" width="70px">
                </div>
                <div class="rule-description-text">
                    <h2>My rule is:</h2>
                    <h2>ANY INCREASING SERIES OF NUMBERS </h2>
                </div>
            </div>
            
            <!-- Guess summary -->
            <div class="guess-summary-area">
                <div class="summary-header-text">
                    <h3>Which of your guesses were attempts to CONFIRM your belief in what you thought the rule was?</h3>
                    <h3>Which of your guesses were attempts to FAlSIFY your belief in what you thought the rule was?</h3>
                </div>
                <div class="summary-body">
                    <div class="summary-body-left">
                        <!-- table consisting of Series| Matches Rule | Rule Guess | Confidence | Tried to falsify|  -->
                        <table id="resultsTable">
                        </table> 
                    </div>
                    <div class="summary-body-right">

                        <div class="feedback-text"></div>
                        <!-- button -->
                        <button id="next-guess-btn" onclick="viewNextGuess()">Explore my next guess</button>
                        <button id="compare-results-btn" onclick="viewResultsComparison()">Compare my results</button>
                    </div>
                </div>
            </div>
        <div>

        <!-- Modal -->
        <!-- 
        <div id="ruleModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Your Guess: <span id="ruleGuessLabel"></span></h2>
                <br />
                <h2>Confidence: <span id="confidence-label-modal"></span></h2>
                <br />
                <h2>Correct Rule: <span id="correctRule"></span></h2>

                <p id="modalText"> Some additional text here</p>
                <button id="closeModal">Okay</button>
            </div>
        </div>
        -->

        <script>
            // Update confidence percentage on slider change
            function updateSliderLabel() {
                var slider = document.getElementById("myRange");
                var output = document.getElementById("confidence-label");
                output.innerHTML = "Confidence: " + slider.value + "%";
            }

            // functions to confirm if sequences of 3 numbers follow a rule
            function isIncreasingByOne(a, b, c) {
                return b === a + 1 && c === b + 1;
            }
            function isDecreasingByOne(a, b, c) {
                return b === a - 1 && c === b - 1;
            }
            function isIncreasingByTwo(a, b, c) {
                console.log("checking if increasing by 2");
                console.log(
                    "numbers(post type conversation): " +
                        a +
                        ", " +
                        b +
                        ", " +
                        c
                );

                let isTrue = b === a + 2 && c === b + 2;
                console.log("is true: " + isTrue);
                return isTrue;
                // return b === a + 2 && c === b + 2;
            }
            function isDecreasingByTwo(a, b, c) {
                return b === a - 2 && c === b - 2;
            }
            function isFibonacci(a, b, c) {
                return a + b === c;
            }
            function isIncreasing(a, b, c) {
                return b > a && c > b;
            }
            function isDecreasing(a, b, c) {
                return b < a && c < b;
            }
            function areAllNumbersPositive(num1, num2, num3) {
                return num1 > 0 && num2 > 0 && num3 > 0;
            }
            function areAllNumbersNegative(num1, num2, num3) {
                return num1 < 0 && num2 < 0 && num3 < 0;
            }
            function any3Numbers(num1, num2, num3) {
                return true;
            }
            function isPrime(num) {
                for (var i = 2; i < num; i++) if (num % i === 0) return false;
                return num > 1;
            }
            function areAllNumbersPrime(num1, num2, num3) {
                return isPrime(num1) && isPrime(num2) && isPrime(num3);
            }
            function sqareOfPrevious(num1, num2, num3) {
                return num1 * num1 === num2 && num2 * num2 === num3;
            }

            // dictionary matching rule names to functions
            var ruleDict = {
                "Increase by 1": isIncreasingByOne,
                "Decrease by 1": isDecreasingByOne,
                "Increase by 2": isIncreasingByTwo,
                "Decrease by 2": isDecreasingByTwo,
                Fibonacci: isFibonacci,
                "Increasing order": isIncreasing,
                "Decreasing order": isDecreasing,
                "All positive": areAllNumbersPositive,
                "All negative": areAllNumbersNegative,
                "Any 3 numbers (feels too hard lol)": any3Numbers,
                "All prime (also feels hard + dont use primes over 5 digits)":
                    areAllNumbersPrime,
            };

            // Populate rule dropdown
            var ruleDropdown = document.getElementById("correctRule");
            for (var key in ruleDict) {
                var option = document.createElement("option");
                option.text = key;
                ruleDropdown.add(option);
            }

            // App States
            let entryCount = 0;

            // Data structue to contain submitted guesses
            // Contains objects with the following properties: entryNumber, sequence, rule, matchesRule, confidence
            let userEntries = [];

            // Handle series entry
            // Move to next field when 4 digits are entered, back to previous field if backspace is pressed and field is empty
            document
                .getElementById("number1")
                .addEventListener("input", function () {
                    if (this.value.length === this.maxLength) {
                        document.getElementById("number2").focus();
                    }
                });

            document
                .getElementById("number2")
                .addEventListener("input", function () {
                    if (this.value.length === this.maxLength) {
                        document.getElementById("number3").focus();
                    }
                });

            document
                .getElementById("number2")
                .addEventListener("keydown", function (e) {
                    if (e.key === "Backspace" && this.value.length === 0) {
                        // Prevent default backspace behavior occuring after cursor is refocused on previous field
                        e.preventDefault();
                        document.getElementById("number1").focus();
                    }
                });

            document
                .getElementById("number3")
                .addEventListener("keydown", function (e) {
                    if (e.key === "Backspace" && this.value.length === 0) {
                        // Prevent default backspace behavior occuring after cursor is refocused on previous field
                        e.preventDefault();
                        document.getElementById("number2").focus();
                    }
                });

            function enforceMaxLength(fieldId) {
                var field = document.getElementById(fieldId);
                field.addEventListener("input", function () {
                    if (this.value.length > 4) {
                        this.value = this.value.slice(0, 4);
                    }
                    if (this.value.length === 4) {
                        // Move to next field if there is one
                        var nextField = document.getElementById(
                            this.dataset.nextFieldId
                        );
                        if (nextField) {
                            nextField.focus();
                        }
                    }
                });
            }
            enforceMaxLength("number1");
            enforceMaxLength("number2");
            enforceMaxLength("number3");

            // Handle guess Submission and Update Table
            document
                .getElementById("dataForm")
                .addEventListener("submit", function (event) {
                    // Rest of event handler ...
                    event.preventDefault();

                    let submitter = event.submitter;
                    let handler = submitter.id;

                    let clickedButtonId = event.submitter.id;
                    if (clickedButtonId === "finalGuessBtn") {
                        // submitFinalGuess();
                        console.log('finalGuessBtn pressed');
                        submitGuess();
                        submitFinalGuess()
                        // return;
                    }
                    else if (clickedButtonId === "submitGuessBtn") {
                        // submitGuess();
                        console.log('submitGuessBtn pressed'); // triggered on enter key
                        submitGuess();
                        // return;
                    }
                    else {
                        console.log('Error: unknown button clicked');
                    }

                    return;


                    // console.log('Submitted:' + submitter);
                    // console.log('Handler:' + handler);

                    // console.log('Event:' + event);
                    // event.preventDefault();

                    // console.log('Event:' + event);

                    // let activeElement = document.activeElement.id;
                    // console.log('Active Element:' + activeElement);

                    // Retrieve form data
                    let number1 = document.getElementById("number1").value;
                    let number2 = document.getElementById("number2").value;
                    let number3 = document.getElementById("number3").value;
                    let rule = document.getElementById("rule").value;
                    let confidence = document.getElementById("myRange").value;

                    // Get correct rule from admin panel
                    let correctRule =
                        document.getElementById("correctRule").value;
                    // Check if the numbers follow the rule
                    let isCorrect = ruleDict[correctRule](
                        parseInt(number1),
                        parseInt(number2),
                        parseInt(number3)
                    );

                    // Add entry to userEntries array
                    userEntries.push({
                        entryNumber: entryCount,
                        sequence: number1 + ", " + number2 + ", " + number3,
                        rule: rule,
                        matchesRule: isCorrect,
                        confidence: confidence,
                    });

                    console.log(userEntries);

                    // Adding a new row to the table
                    let table = document.getElementById("dataTable");
                    let newRow = table.insertRow();
                    let cell1 = newRow.insertCell(0);
                    let cell2 = newRow.insertCell(1);
                    let cell3 = newRow.insertCell(2);
                    let cell4 = newRow.insertCell(3);
                    let cell5 = newRow.insertCell(4);

                    entryCount++;

                    // Display entry in table
                    cell1.innerHTML = entryCount;
                    cell2.innerHTML = number1 + ", " + number2 + ", " + number3;
                    cell3.innerHTML = rule;
                    cell4.innerHTML = isCorrect;
                    cell5.innerHTML = confidence + "%";

                    // console.log('numbers(pre type conversation): ' + number1 + ', ' + number2 + ', ' + number3);

                    // Clearing the form for next entry
                    document.getElementById("dataForm").reset();

                    // If the user has submitted 3 entries, display the final guess button
                    if (entryCount === 3) {
                        document.getElementById(
                            "finalGuessButton"
                        ).style.display = "block";
                    }
                });


            function submitGuess() {

                    // Retrieve form data
                    let number1 = document.getElementById("number1").value;
                    let number2 = document.getElementById("number2").value;
                    let number3 = document.getElementById("number3").value;
                    let rule = document.getElementById("rule").value;
                    let confidence = document.getElementById("myRange").value;

                    // Get correct rule from admin panel
                    let correctRule =
                        document.getElementById("correctRule").value;
                    // Check if the numbers follow the rule
                    let isCorrect = ruleDict[correctRule](
                        parseInt(number1),
                        parseInt(number2),
                        parseInt(number3)
                    );

                    // Add entry to userEntries array
                    userEntries.push({
                        entryNumber: entryCount,
                        sequence: number1 + ", " + number2 + ", " + number3,
                        rule: rule,
                        matchesRule: isCorrect,
                        confidence: confidence,
                    });

                    console.log(userEntries);

                    // Adding a new row to the table
                    let table = document.getElementById("dataTable");
                    let newRow = table.insertRow();
                    let cell1 = newRow.insertCell(0);
                    let cell2 = newRow.insertCell(1);
                    let cell3 = newRow.insertCell(2);
                    let cell4 = newRow.insertCell(3);
                    let cell5 = newRow.insertCell(4);

                    entryCount++;

                    // Display entry in table
                    cell1.innerHTML = entryCount;
                    cell2.innerHTML = number1 + ", " + number2 + ", " + number3;
                    cell3.innerHTML = rule;
                    cell4.innerHTML = isCorrect;
                    cell5.innerHTML = confidence + "%";

                    // console.log('numbers(pre type conversation): ' + number1 + ', ' + number2 + ', ' + number3);

                    // Clearing the form for next entry
                    document.getElementById("dataForm").reset();

                    // If the user has submitted 3 entries, display the final guess button
                    if (entryCount === 3) {
                        document.getElementById(
                            "finalGuessButton"
                        ).style.display = "block";
                    }
            }


            function addSingleRowToChart(inputString, color) {
                // Adds a single row to the table that is not broken into cells
                var table = document.getElementById("dataTable");
                var newRow = table.insertRow();
                var newCell = newRow.insertCell(0);
                // Get number of columns in table
                var colCount = table.rows[0].cells.length;
                newCell.colSpan = colCount;
                newCell.innerHTML = inputString;
                newCell.style.textAlign = "center";

                // set color of new row if specified
                if (color) {
                    newCell.style.backgroundColor = color;
                }
                // cell color light green
                // newCell.style.backgroundColor = "#e8f5e9";
            }

            // Test: set default text/values for all fields
            // document.getElementById("number1").value = 1;
            // document.getElementById("number2").value = 2;
            // document.getElementById("number3").value = 3;
            // document.getElementById("rule").value = "Increase by 1";
            // document.getElementById("ruleGuess").value = "Increase by 1";

            // Function to submitFinalGuess
            async function submitFinalGuess() {

                loadResultsPage();
                return; // Exit execution until use for rendering comparison
                
                console.log("submitting final guess");

                // Get correct rule from admin panel
                let correctRule = document.getElementById("correctRule").value;

                // Get rule guess from user
                let ruleGuess = document.getElementById("rule").value;

                // Fetch key parameter from URL
                const urlParams = new URLSearchParams(window.location.search);
                const apiKey = urlParams.get("key");

                const instructions = `
Your job is to emulate Watson’s “2, 4, 6” experiment, in which there is a rule describing a sequence of numbers. 

For example, the rule “Numbers increase by 2” may be paired with the sequence 0, 2, 4. 

Students view multiple number sequences and then attempt to guess the pre-determined rule that applies to them.

Your job is to compare the actual rule with a user-submitted rule guess and determine if their guess is correct, even if they are phrased slightly differently. 

Note that that a rule and rule guess may sound similar but have inherently different meanings. For example, the guess “Numbers go up” technically covers the scope of “Numbers double each time” but they are not the same rule. 

Please respond with only “true” or “false”.`;

                const prompt = `Actual Rule: ${correctRule}. Rule Guess: ${ruleGuess}.`;

                const jsonBody = {
                    model: "gpt-4",
                    messages: [
                        {
                            role: "system",
                            content: `${instructions}`,
                        },
                        {
                            role: "user",
                            content: `${prompt}`,
                        },
                    ],
                    temperature: 1,
                    max_tokens: 256,
                    top_p: 1,
                    frequency_penalty: 0,
                    presence_penalty: 0,
                };
                // Sent final guess to API
                try {
                    fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${apiKey}`,
                        },
                        body: JSON.stringify(jsonBody),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            const apiResponse =
                                data.choices[0].message.content.trim();
                            // document.getElementById('apiResponse').innerText = apiResponse;
                            console.log("apiResponse: ", apiResponse);
                            alert(apiResponse);
                        })
                        .catch((error) => console.error("Error:", error));
                } catch (error) {
                    console.error(error);
                }
            }

            function loadResultsPage(){
                // Hide app container
                document.querySelector('.app-container').style.display = 'none';

                // Show results page container
                document.querySelector('.results-page-container').style.display = 'flex';

                renderTable(userEntries);

            }


            // Results page functions
            currentRow = 0;
            
            function renderTable(userGuesses) {

                console.log('rendering table');

                // Table formatted as Series (3 numbers), Matches Rule (Yes/No), Rule Guess (text), Confidence (1-100%), Tried to falsify (Yes/No)

                // Select table
                var table = document.getElementById("resultsTable");

                // Create table header
                var header = table.createTHead();
                // set class of header row
                header.classList.add('results-table-header');


                var row = header.insertRow(0);
                row.classList.add('results-table-row');

                var cell = row.insertCell(0);
                cell.classList.add('results-table-cell');
                cell.innerHTML = "<b>Series</b>";
                cell = row.insertCell(1);
                cell.innerHTML = "<b>Matches Rule</b>";
                cell = row.insertCell(2);
                cell.innerHTML = "<b>Rule Guess</b>";
                cell = row.insertCell(3);
                cell.innerHTML = "<b>Confidence</b>";
                cell = row.insertCell(4);
                cell.innerHTML = "<b>Tried to falsify</b>";

                // Create table body
                var body = table.createTBody();
                for (var i = 0; i < userGuesses.length; i++) {
                    var row = body.insertRow(i);
                    if(i === currentRow) row.classList.add('highlighted-row'); // highlights first row

                    var cell = row.insertCell(0);
                    cell.innerHTML = userGuesses[i].sequence;
                    cell = row.insertCell(1);
                    cell.innerHTML = userGuesses[i].matchesRule;
                    cell = row.insertCell(2);
                    cell.innerHTML = userGuesses[i].rule;
                    cell = row.insertCell(3);
                    cell.innerHTML = userGuesses[i].confidence;
                    cell = row.insertCell(4);
                    // cell.innerHTML = userGuesses[i].triedToFalsify;
                }
                renderGuessFeedback(currentRow);
            }
            // renderTable(userGuesses);


            function viewNextGuess() {
                console.log('viewing next guess');
                var table = document.getElementById("resultsTable");

                // Remove highlight from current row
                table.rows[currentRow + 1].classList.remove('highlighted-row');

                // Move to next row
                currentRow++;
                if(currentRow >= table.rows.length - 2) {
                    //currentRow = 0; // Wraps around to the first row when it reaches the end
                    // Swap out button for "View Results Comparison" button
                    document.getElementById("next-guess-btn").style.display = "none";
                    document.getElementById("compare-results-btn").style.display = "block";
                }

                // Add highlight to new row
                table.rows[currentRow + 1].classList.add('highlighted-row');

                // console.log its data
                console.log(userEntries[currentRow]);
                renderGuessFeedback(currentRow);
            }
            function viewPreviousGuess() {

            }
            function viewResultsComparison() {

            }

            // Render guess feedback
            function renderGuessFeedback(guessNumber){
                // Display feedback for guess number

                // Get guess
                let guess = userEntries[guessNumber];
                let guessRule = guess.rule;
                let guessSequence = guess.sequence;
                let guessMatchesRule = guess.matchesRule;
                let guessConfidence = guess.confidence;

                // Ternary operator: if guess number is 0, then use 'first', else use 'next'
                let guessNumberText = guessNumber === 0 ? 'first' : 'next';

                let feedbackText =
                `<p>For your ${guessNumberText} guess, your hypothesis was <b>${guessRule}</b>.</p>
                <p>The number series you used for your first guess was <b>${guessSequence}</b>.</p>
                <p>Your first guess was an attempt to confirm your hypothesis.</p>
                <p>What I mean by that is that the number series you used in your first guess was a number series that fit the rule that you hypothesized to be my rule.</p>
                <p>Therefore, your first guess was not an attempt to falsify your hypothesis.</p>`;

                // Add feedback to summary body right
                document.querySelector('.feedback-text').innerHTML = feedbackText;

                fetchDisprovalFeedback();

            }


            // function to get feedback on hypothesis disproving 
            async function fetchDisprovalFeedback() {
                // Fetch key parameter from URL
                const urlParams = new URLSearchParams(window.location.search);
                const apiKey = urlParams.get("key");

                // Load text from feedbackPrompt.txt
                const instructions = await fetch('feedbackPrompt.txt')
                    .then(response => response.text())
                    .then(data => {
                        return data;
                    })
                    .catch(error => {
                        console.error(error);
                        // TODO: alert of error + cleanup execution
                        return;
                    });
                
                console.log('instructions: ', instructions);
                console.log('userEntries: ', userEntries);

                // Convert all contents of userEntries into a readable string
                const prompt = JSON.stringify(userEntries);
                console.log(prompt);

                const jsonBody = {
                    model: "gpt-4-1106-preview", // gpt-4 vs gpt-4-1106-preview
                    messages: [
                        {
                            role: "system",
                            content: `${instructions}`,
                        },
                        {
                            role: "user",
                            content: `${prompt}`,
                        },
                    ],
                    temperature: 1,
                    max_tokens: 256,
                    top_p: 1,
                    frequency_penalty: 0,
                    presence_penalty: 0,
                };
                // Sent final guess to API
                try {
                    fetch("https://api.openai.com/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            Authorization: `Bearer ${apiKey}`,
                        },
                        body: JSON.stringify(jsonBody),
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            console.log("content before trim: ", data.choices[0].message.content);
                            const apiResponse =
                                data.choices[0].message.content.trim();
                            // document.getElementById('apiResponse').innerText = apiResponse;
                            console.log("apiResponse: ", apiResponse);
                            alert(apiResponse);

                            let responseExample = `apiResponse:  [
                            {
    "entryNumber": 0,
    "disproveAttempt": false
  },
  {
    "entryNumber": 1,
    "disproveAttempt": false
  },
  {
    "entryNumber": 2,
    "disproveAttempt": false
  } `

                        // extract disproveAttempt values from apiResponse
                        let disproveAttempts = JSON.parse(apiResponse);
                        console.log('disproveAttempts: ', disproveAttempts);
                        // iterate through disproveAttempts and log
                        for (let i = 0; i < disproveAttempts.length; i++) {
                            console.log('disproveAttempt: ', disproveAttempts[i].disproveAttempt);
                        }

                        // Render disprove attempts in tables Tried to falsify column
                        let table = document.getElementById("resultsTable");
                        for (let i = 0; i < disproveAttempts.length; i++) {
                            let cell = table.rows[i + 1].cells[4];
                            cell.innerHTML = disproveAttempts[i].disproveAttempt;
                        }


                        })
                        .catch((error) => console.error("Error:", error));
                } catch (error) {
                    console.error(error);
                }

            }
            // fetchDisprovalFeedback();

        </script>
    </body>
</html>
